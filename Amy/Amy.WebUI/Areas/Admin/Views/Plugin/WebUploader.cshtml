
@{
    ViewBag.Title = "WebUploader";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<!-- 面包屑 start -->
<div id="title-breadcrumb-option-demo" class="page-title-breadcrumb">
    <ol class="breadcrumb page-breadcrumb pull-left">
        <li><i class="fa fa-home"></i>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/admin/manager">工作台</a>&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-angle-right"></i>&nbsp;&nbsp;</li>
        <li><a href="javascript:void(0);">实用插件示例</a>&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-angle-right"></i>&nbsp;&nbsp;</li>
        <li class="active">@ViewBag.Title</li>
    </ol>
    <div class="clearfix"></div>
</div>
<!-- 面包屑 end -->
<!-- 右侧内容 start -->
<div class="page-content">
    <div class="row">
        <div class="col-lg-12">
            <div class="note note-warning" style="color:#777777">
                <h3><a href="http://fex.baidu.com/webuploader/" target="_blank">WebUploader!</a> 采用大文件分片并发上传，极大的提高了文件上传效率。</h3>
                <p>WebUploader是由Baidu WebFE(FEX)团队开发的一个简单的以HTML5为主，FLASH为辅的现代文件上传组件。在现代的浏览器里面能充分发挥HTML5的优势，同时又不摒弃主流IE浏览器，沿用原来的FLASH运行时，兼容IE6+，iOS 6+, android 4+。两套运行时，同样的调用方式，可供用户任意选用。</p>
            </div>
        </div>

        <div class="col-lg-12">
            <div class="panel panel-yellow">
                <div class="panel-heading">大文件上传示例</div>
                <div class="panel-body pan">
                    <form id="amy-form" action="@Url.Action("Save", "Forms", new { area="Demo" })" method="post" class="form-horizontal">
                        <div class="form-body pal">
                            <div class="form-group">
                                <label for="code" class="col-md-3 control-label">用户文档：</label>
                                <div class="col-md-6">
                                    <input id="Pictrue" name="Picture" type="hidden" />
                                    <div id="uploader" class="wu-example">
                                        <!--用来存放文件信息-->
                                        <div class="filename"></div>
                                        <div class="state"></div>
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-info progress-bar-striped active" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 0%;min-width:2%">
                                                0%
                                            </div>
                                        </div>
                                        <div class="btns">
                                            <div id="picker" class="btn btn-green">选择文件</div>
                                            <a id="ctlBtn" class="btn btn-green">开始上传</a>
                                            <a id="pause" class="btn btn-red">暂停上传</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <div class="col-md-offset-3 col-md-9">
                                <a href="javascript:history.back(-1)" class="btn btn-green">返回</a>&nbsp;
                                <button class="btn btn-primary" type="submit">保存</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>
<!-- 右侧内容 end -->

@section styles{
    <link href="/content/mgr/vendors/webuploader/webuploader.css" rel="stylesheet" />
}

@section scripts{
    <script src="/content/mgr/vendors/webuploader/webuploader.min.js"></script>

    <script type="text/javascript">
        $(function () {
            $('#amy-form').myValidate(function (form) {
                $(form).ajaxSubmit({
                    success: function (res) {
                        if (res.Flag) {
                            amy.alert(res.Content);
                        }
                        else {
                            amy.alert(res.Content[0][1]);
                        }
                    },
                    error: function () {

                    },
                    dataType: "json"
                })
            });

            var GUID = WebUploader.Base.guid();//一个GUID

            var uploader = WebUploader.create({
                swf: '/content/mgr/vendors/webuploader/Uploader.swf',
                server: '/admin/plugin/uploadsliverfile',
                pick: '#picker',
                resize: false,
                chunked: true,//开始分片上传
                chunkSize: 2048000,//每一片的大小
                formData: {
                    guid: GUID //自定义参数，待会儿解释
                }
            });

            uploader.on('fileQueued', function (file) {
                $("#uploader .filename").html("文件名：" + file.name);
                $("#uploader .state").html('等待上传');
                $("#uploader .progress-bar").width('0%');
                $("#uploader .progress-bar").text('0%');
                $('#ctlBtn').removeAttr('disabled');
            });

            uploader.on('uploadProgress', function (file, percentage) {
                $("#uploader .progress-bar").width(percentage * 100 + '%');
                $("#uploader .progress-bar").text(parseInt(percentage * 100) + '%');
            });

            uploader.on('uploadSuccess', function (file) {
                $.post('/admin/plugin/mergesliverfile', { guid: GUID, fileName: file.name }, function (data) {
                    $("#uploader .progress-bar").removeClass('progress-bar-striped').removeClass('active').removeClass('progress-bar-info').addClass('progress-bar-success');
                    $("#uploader .state").html("上传成功...");
                    $("#Pictrue").val(data.path);
                });
            });

            uploader.on('uploadError', function () {
                $("#uploader .progress-bar").removeClass('progress-bar-striped').removeClass('active').removeClass('progress-bar-info').addClass('progress-bar-danger');
                $("#uploader .state").html("上传失败...");
            });

            $("#ctlBtn").click(function () {
                uploader.upload();
                $("#ctlBtn").text("上传");
                $('#ctlBtn').attr('disabled', 'disabled');
                $("#uploader .progress-bar").addClass('progress-bar-striped').addClass('active');
                $("#uploader .state").html("上传中...");
            });

            $('#pause').click(function () {
                uploader.stop(true);
                $('#ctlBtn').removeAttr('disabled');
                $("#ctlBtn").text("继续上传");
                $("#uploader .state").html("暂停中...");
                $("#uploader .progress-bar").removeClass('progress-bar-striped').removeClass('active');
            });
        });
    </script>



}